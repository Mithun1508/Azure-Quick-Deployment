{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "Prefix": {
      "type": "string",
      "defaultValue": "AZE2",
      "allowedValues": [
        "AZE2",
        "AZC1",
        "AEU2",
        "ACU1"
      ]
    },
    "Environment": {
      "type": "string",
      "defaultValue": "D",
      "allowedValues": [
        "I",
        "D",
        "U",
        "P",
        "S",
        "G",
        "A"
      ]
    },
    "DeploymentID": {
      "type": "string",
      "defaultValue": "1",
      "allowedValues": [
        "0",
        "1",
        "2",
        "3",
        "4",
        "5",
        "6",
        "7",
        "8",
        "9"
      ]
    },
    "Stage": {
      "type": "object"
    },
    "Extensions": {
      "type": "object"
    },
    "Global": {
      "type": "object"
    },
    "DeploymentInfo": {
      "type": "object"
    },
    "vmAdminPassword": {
      "type": "securestring"
    },
    "devOpsPat": {
      "type": "securestring"
    },
    "sshPublic": {
      "type": "securestring"
    }
  },
  "variables": {
    "Deployment": "[concat(parameters('Prefix'),'-',parameters('Global').OrgName,'-',parameters('Global').Appname,'-',parameters('Environment'),parameters('DeploymentID'))]",
    "DeploymentURI": "[toLower(concat(parameters('Prefix'),parameters('Global').OrgName,parameters('Global').Appname,parameters('Environment'),parameters('DeploymentID')))]",
    "dataRetention": 31,
    "serviceTier": "pernode",
    "AAserviceTier": "OMS",
    "OMSworkspaceName": "[replace(concat(variables('DeploymentURI'),'LogAnalytics'),'-','')]",
    "OMSworkspaceID": "[resourceid('Microsoft.OperationalInsights/workspaces/',variables('OMSworkspaceName'))]",
    "AAName": "[replace(concat(variables('DeploymentURI'),'OMSAutomation'),'-','')]",
    "AppInsightsName": "[replace(concat(variables('DeploymentURI'),'AppInsights'),'-','')]",
    "appConfigurationInfo": "[if(contains(parameters('DeploymentInfo'),'appConfigurationInfo'),parameters('DeploymentInfo').appConfigurationInfo,json('null'))]",
    "dataSources": [
      {
        "name": "AzureActivityLog",
        "kind": "AzureActivityLog",
        "properties": {
          "linkedResourceId": "[concat(subscription().id, '/providers/Microsoft.Insights/eventTypes/management')]"
        }
      },
      {
        "name": "LogicalDisk1",
        "kind": "WindowsPerformanceCounter",
        "properties": {
          "objectName": "LogicalDisk",
          "instanceName": "*",
          "intervalSeconds": 10,
          "counterName": "Avg Disk sec/Read"
        }
      },
      {
        "name": "LogicalDisk2",
        "kind": "WindowsPerformanceCounter",
        "properties": {
          "objectName": "LogicalDisk",
          "instanceName": "*",
          "intervalSeconds": 10,
          "counterName": "Avg Disk sec/Write"
        }
      },
      {
        "name": "LogicalDisk3",
        "kind": "WindowsPerformanceCounter",
        "properties": {
          "objectName": "LogicalDisk",
          "instanceName": "*",
          "intervalSeconds": 10,
          "counterName": "Current Disk Queue Length"
        }
      },
      {
        "name": "LogicalDisk4",
        "kind": "WindowsPerformanceCounter",
        "properties": {
          "objectName": "LogicalDisk",
          "instanceName": "*",
          "intervalSeconds": 10,
          "counterName": "Disk Reads/sec"
        }
      },
      {
        "name": "LogicalDisk5",
        "kind": "WindowsPerformanceCounter",
        "properties": {
          "objectName": "LogicalDisk",
          "instanceName": "*",
          "intervalSeconds": 10,
          "counterName": "Disk Transfers/sec"
        }
      },
      {
        "name": "LogicalDisk6",
        "kind": "WindowsPerformanceCounter",
        "properties": {
          "objectName": "LogicalDisk",
          "instanceName": "*",
          "intervalSeconds": 10,
          "counterName": "Disk Writes/sec"
        }
      },
      {
        "name": "LogicalDisk7",
        "kind": "WindowsPerformanceCounter",
        "properties": {
          "objectName": "LogicalDisk",
          "instanceName": "*",
          "intervalSeconds": 10,
          "counterName": "Free Megabytes"
        }
      },
      {
        "name": "LogicalDisk8",
        "kind": "WindowsPerformanceCounter",
        "properties": {
          "objectName": "LogicalDisk",
          "instanceName": "*",
          "intervalSeconds": 10,
          "counterName": "% Free Space"
        }
      },
      {
        "name": "LogicalDisk9",
        "kind": "WindowsPerformanceCounter",
        "properties": {
          "objectName": "LogicalDisk",
          "instanceName": "*",
          "intervalSeconds": 10,
          "counterName": "Avg Disk sec/Transfer"
        }
      },
      {
        "name": "LogicalDisk10",
        "kind": "WindowsPerformanceCounter",
        "properties": {
          "objectName": "LogicalDisk",
          "instanceName": "*",
          "intervalSeconds": 10,
          "counterName": "Disk Bytes/sec"
        }
      },
      {
        "name": "LogicalDisk11",
        "kind": "WindowsPerformanceCounter",
        "properties": {
          "objectName": "LogicalDisk",
          "instanceName": "*",
          "intervalSeconds": 10,
          "counterName": "Disk Read Bytes/sec"
        }
      },
      {
        "name": "LogicalDisk12",
        "kind": "WindowsPerformanceCounter",
        "properties": {
          "objectName": "LogicalDisk",
          "instanceName": "*",
          "intervalSeconds": 10,
          "counterName": "Disk Write Bytes/sec"
        }
      },
      {
        "name": "PhysicalDisk",
        "kind": "WindowsPerformanceCounter",
        "properties": {
          "objectName": "PhysicalDisk",
          "instanceName": "_Total",
          "intervalSeconds": 10,
          "counterName": "% Free Space"
        }
      },
      {
        "name": "PhysicalDisk1",
        "kind": "WindowsPerformanceCounter",
        "properties": {
          "objectName": "PhysicalDisk",
          "instanceName": "_Total",
          "intervalSeconds": 10,
          "counterName": "% Disk Time"
        }
      },
      {
        "name": "PhysicalDisk2",
        "kind": "WindowsPerformanceCounter",
        "properties": {
          "objectName": "PhysicalDisk",
          "instanceName": "_Total",
          "intervalSeconds": 10,
          "counterName": "% Disk Read Time"
        }
      },
      {
        "name": "PhysicalDisk3",
        "kind": "WindowsPerformanceCounter",
        "properties": {
          "objectName": "PhysicalDisk",
          "instanceName": "_Total",
          "intervalSeconds": 10,
          "counterName": "% Disk Write Time"
        }
      },
      {
        "name": "PhysicalDisk4",
        "kind": "WindowsPerformanceCounter",
        "properties": {
          "objectName": "PhysicalDisk",
          "instanceName": "_Total",
          "intervalSeconds": 10,
          "counterName": "Disk Transfers/sec"
        }
      },
      {
        "name": "PhysicalDisk5",
        "kind": "WindowsPerformanceCounter",
        "properties": {
          "objectName": "PhysicalDisk",
          "instanceName": "_Total",
          "intervalSeconds": 10,
          "counterName": "Disk Reads/sec"
        }
      },
      {
        "name": "PhysicalDisk6",
        "kind": "WindowsPerformanceCounter",
        "properties": {
          "objectName": "PhysicalDisk",
          "instanceName": "_Total",
          "intervalSeconds": 10,
          "counterName": "Disk Writes/sec"
        }
      },
      {
        "name": "PhysicalDisk7",
        "kind": "WindowsPerformanceCounter",
        "properties": {
          "objectName": "PhysicalDisk",
          "instanceName": "_Total",
          "intervalSeconds": 10,
          "counterName": "Disk Bytes/sec"
        }
      },
      {
        "name": "PhysicalDisk8",
        "kind": "WindowsPerformanceCounter",
        "properties": {
          "objectName": "PhysicalDisk",
          "instanceName": "_Total",
          "intervalSeconds": 10,
          "counterName": "Disk Read Bytes/sec"
        }
      },
      {
        "name": "PhysicalDisk9",
        "kind": "WindowsPerformanceCounter",
        "properties": {
          "objectName": "PhysicalDisk",
          "instanceName": "_Total",
          "intervalSeconds": 10,
          "counterName": "Disk Write Bytes/sec"
        }
      },
      {
        "name": "PhysicalDisk10",
        "kind": "WindowsPerformanceCounter",
        "properties": {
          "objectName": "PhysicalDisk",
          "instanceName": "_Total",
          "intervalSeconds": 10,
          "counterName": "Avg. Disk Queue Length"
        }
      },
      {
        "name": "PhysicalDisk11",
        "kind": "WindowsPerformanceCounter",
        "properties": {
          "objectName": "PhysicalDisk",
          "instanceName": "_Total",
          "intervalSeconds": 10,
          "counterName": "Avg. Disk Read Queue Length"
        }
      },
      {
        "name": "PhysicalDisk12",
        "kind": "WindowsPerformanceCounter",
        "properties": {
          "objectName": "PhysicalDisk",
          "instanceName": "_Total",
          "intervalSeconds": 10,
          "counterName": "Avg. Disk Write Queue Length"
        }
      },
      {
        "name": "PhysicalDisk13",
        "kind": "WindowsPerformanceCounter",
        "properties": {
          "objectName": "PhysicalDisk",
          "instanceName": "*",
          "intervalSeconds": 10,
          "counterName": "Disk Transfers/sec"
        }
      },
      {
        "name": "Memory1",
        "kind": "WindowsPerformanceCounter",
        "properties": {
          "objectName": "Memory",
          "instanceName": "*",
          "intervalSeconds": 10,
          "counterName": "Available MBytes"
        }
      },
      {
        "name": "Memory2",
        "kind": "WindowsPerformanceCounter",
        "properties": {
          "objectName": "Memory",
          "instanceName": "*",
          "intervalSeconds": 10,
          "counterName": "% Committed Bytes In Use"
        }
      },
      {
        "name": "Network1",
        "kind": "WindowsPerformanceCounter",
        "properties": {
          "objectName": "Network Adapter",
          "instanceName": "*",
          "intervalSeconds": 10,
          "counterName": "Bytes Received/sec"
        }
      },
      {
        "name": "Network2",
        "kind": "WindowsPerformanceCounter",
        "properties": {
          "objectName": "Network Adapter",
          "instanceName": "*",
          "intervalSeconds": 10,
          "counterName": "Bytes Sent/sec"
        }
      },
      {
        "name": "Network3",
        "kind": "WindowsPerformanceCounter",
        "properties": {
          "objectName": "Network Adapter",
          "instanceName": "*",
          "intervalSeconds": 10,
          "counterName": "Bytes Total/sec"
        }
      },
      {
        "name": "CPU1",
        "kind": "WindowsPerformanceCounter",
        "properties": {
          "objectName": "Processor",
          "instanceName": "_Total",
          "intervalSeconds": 10,
          "counterName": "% Processor Time"
        }
      },
      {
        "name": "CPU2",
        "kind": "WindowsPerformanceCounter",
        "properties": {
          "objectName": "Processor",
          "instanceName": "_Total",
          "intervalSeconds": 10,
          "counterName": "% Privileged Time"
        }
      },
      {
        "name": "CPU3",
        "kind": "WindowsPerformanceCounter",
        "properties": {
          "objectName": "Processor",
          "instanceName": "_Total",
          "intervalSeconds": 10,
          "counterName": "% User Time"
        }
      },
      {
        "name": "CPU5",
        "kind": "WindowsPerformanceCounter",
        "properties": {
          "objectName": "Processor Information",
          "instanceName": "_Total",
          "intervalSeconds": 10,
          "counterName": "Processor Frequency"
        }
      },
      {
        "name": "CPU6",
        "kind": "WindowsPerformanceCounter",
        "properties": {
          "objectName": "System",
          "instanceName": "*",
          "intervalSeconds": 10,
          "counterName": "Processor Queue Length"
        }
      },
      {
        "name": "System",
        "kind": "WindowsEvent",
        "properties": {
          "eventLogName": "System",
          "eventTypes": [
            {
              "eventType": "Error"
            },
            {
              "eventType": "Warning"
            }
          ]
        }
      },
      {
        "name": "Application",
        "kind": "WindowsEvent",
        "properties": {
          "eventLogName": "Application",
          "eventTypes": [
            {
              "eventType": "Error"
            },
            {
              "eventType": "Warning"
            }
          ]
        }
      },
      {
        "name": "DSCEventLogs",
        "kind": "WindowsEvent",
        "properties": {
          "eventLogName": "Microsoft-Windows-DSC/Operational",
          "eventTypes": [
            {
              "eventType": "Error"
            },
            {
              "eventType": "Warning"
            },
            {
              "eventType": "Information"
            }
          ]
        }
      },
      {
        "name": "TSSessionManager",
        "kind": "WindowsEvent",
        "properties": {
          "eventLogName": "Microsoft-Windows-TerminalServices-LocalSessionManager/Operational",
          "eventTypes": [
            {
              "eventType": "Error"
            },
            {
              "eventType": "Warning"
            },
            {
              "eventType": "Information"
            }
          ]
        }
      },
      {
        "name": "Linux",
        "kind": "LinuxPerformanceObject",
        "properties": {
          "performanceCounters": [
            {
              "counterName": "% Used Inodes"
            },
            {
              "counterName": "Free Megabytes"
            },
            {
              "counterName": "% Used Space"
            },
            {
              "counterName": "Disk Transfers/sec"
            },
            {
              "counterName": "Disk Reads/sec"
            },
            {
              "counterName": "Disk Writes/sec"
            }
          ],
          "objectName": "Logical Disk",
          "instanceName": "*",
          "intervalSeconds": 10
        }
      },
      {
        "name": "LinuxPerfCollection",
        "kind": "LinuxPerformanceCollection",
        "properties": {
          "state": "Enabled"
        }
      },
      {
        "name": "IISLog",
        "kind": "IISLogs",
        "properties": {
          "state": "OnPremiseEnabled"
        }
      },
      {
        "name": "Syslog",
        "kind": "LinuxSyslog",
        "properties": {
          "syslogName": "kern",
          "syslogSeverities": [
            {
              "severity": "emerg"
            },
            {
              "severity": "alert"
            },
            {
              "severity": "crit"
            },
            {
              "severity": "err"
            },
            {
              "severity": "warning"
            }
          ]
        }
      },
      {
        "name": "SyslogCollection",
        "kind": "LinuxSyslogCollection",
        "properties": {
          "state": "Enabled"
        }
      }
    ],
    // LogAnalytics Solutions
    "solutions": [
      "AzureAutomation",
      "Updates",
      "Security",
      "AgentHealthAssessment",
      "ChangeTracking",
      "AzureActivity",
      "ADAssessment",
      "ADReplication",
      "SQLAssessment",
      "ServiceMap",
      "AntiMalware",
      "DnsAnalytics",
      "ApplicationInsights",
      "AzureAppGatewayAnalytics",
      "AzureWebAppsAnalytics",
      "KeyVault",
      "AzureNSGAnalytics",
      "AlertManagement",
      "DeviceHealthProd",
      "CapacityPerformance",
      "NetworkMonitoring",
      "WireData2",
      "Containers",
      "ContainerInsights",
      "ServiceFabric",
      "InfrastructureInsights",
      "VMInsights"
    ],
    // AA Assets is to upload Azure Automation DSC Modules
    // Code to generate this table is in the PrereqstoDeploy directory
    // ..\PrereqsToDeploy\5.2-PreReqDSCModuleListAutomation.ps1
    // doing this via ARM is too buggy, module imports often fail
    "aaAssets": {
      "modules": [
        {
          "name": "xPSDesiredStateConfiguration",
          "url": "https://www.powershellgallery.com/api/v2/package/xPSDesiredStateConfiguration/7.0.0.0"
        },
        {
          "name": "xActiveDirectory",
          "url": "https://www.powershellgallery.com/api/v2/package/xActiveDirectory/2.16.0.0"
        },
        {
          "name": "xStorage",
          "url": "https://www.powershellgallery.com/api/v2/package/xStorage/3.2.0.0"
        },
        {
          "name": "xPendingReboot",
          "url": "https://www.powershellgallery.com/api/v2/package/xPendingReboot/0.3.0.0"
        },
        {
          "name": "xComputerManagement",
          "url": "https://www.powershellgallery.com/api/v2/package/xComputerManagement/3.0.0.0"
        },
        {
          "name": "xWebAdministration",
          "url": "https://www.powershellgallery.com/api/v2/package/xWebAdministration/1.18.0.0"
        },
        {
          "name": "xSQLServer",
          "url": "https://www.powershellgallery.com/api/v2/package/xSQLServer/8.2.0.0"
        },
        {
          "name": "xFailOverCluster",
          "url": "https://www.powershellgallery.com/api/v2/package/xFailOverCluster/1.8.0.0"
        },
        {
          "name": "xNetworking",
          "url": "https://www.powershellgallery.com/api/v2/package/xNetworking/5.2.0.0"
        },
        {
          "name": "SecurityPolicyDsc",
          "url": "https://www.powershellgallery.com/api/v2/package/SecurityPolicyDsc/2.0.0.0"
        },
        {
          "name": "xTimeZone",
          "url": "https://www.powershellgallery.com/api/v2/package/xTimeZone/1.6.0.0"
        },
        {
          "name": "xSystemSecurity",
          "url": "https://www.powershellgallery.com/api/v2/package/xSystemSecurity/1.2.0.0"
        },
        {
          "name": "xRemoteDesktopSessionHost",
          "url": "https://www.powershellgallery.com/api/v2/package/xRemoteDesktopSessionHost/1.4.0.0"
        },
        {
          "name": "xRemoteDesktopAdmin",
          "url": "https://www.powershellgallery.com/api/v2/package/xRemoteDesktopAdmin/1.1.0.0"
        },
        {
          "name": "xDSCFirewall",
          "url": "https://www.powershellgallery.com/api/v2/package/xDSCFirewall/1.6.21"
        },
        {
          "name": "xWindowsUpdate",
          "url": "https://www.powershellgallery.com/api/v2/package/xWindowsUpdate/2.7.0.0"
        },
        {
          "name": "PowerShellModule",
          "url": "https://www.powershellgallery.com/api/v2/package/PowerShellModule/0.3"
        },
        {
          "name": "xDnsServer",
          "url": "https://www.powershellgallery.com/api/v2/package/xDnsServer/1.8.0.0"
        },
        {
          "name": "xSmbShare",
          "url": "https://www.powershellgallery.com/api/v2/package/xSmbShare/2.0.0.0"
        }
      ]
    },
    // Saved Searches / Alerts
    // Sample Alert syntax (input object), also saved searches, without alerts
    "alertInfo": [
      {
        "search": {
          "name": "Buffer Cache Hit Ratio2",
          "category": "SQL Performance",
          "query": "Alert | where AlertName == \"Buffer Cache Hit Ratio is too low\" and AlertState != \"Closed\""
        },
        "alert": {
          "displayName": "Buffer Cache Hit Ratio",
          "description": "Buffer Cache Hit Ratio perfmon counter information goes here.",
          "severity": "Warning",
          "enabled": "true",
          "thresholdOperator": "gt",
          "thresholdValue": 0,
          "schedule": {
            "interval": 15,
            "timeSpan": 60
          },
          "throttleMinutes": 60,
          "emailNotification": {
            "recipients": "[parameters('global').alertRecipients]",
            "subject": "buffer hit cache ratio hooya"
          }
        }
      },
      {
        "search": {
          "query": "Type=Event EventID=20 Source=\"Microsoft-Windows-WindowsUpdateClient\" EventLog=\"System\" TimeGenerated>NOW-24HOURS | Measure Count() By Computer",
          "name": "A Software Update Installation Failed 1",
          "category": "Software Updates"
        }
      },
      {
        "search": {
          "query": "Type=Event EventID=20 Source=\"Microsoft-Windows-WindowsUpdateClient\" EventLog=\"System\" TimeGenerated>NOW-168HOURS",
          "name": "A Software Update Installation Failed 2",
          "category": "Software Updates"
        }
      },
      {
        "search": {
          "query": "Type=Event EventID=4202 Source=\"TCPIP\" EventLog=\"System\" TimeGenerated>NOW-24HOURS | Measure Count() By Computer",
          "name": "A Network adatper was disconnected from the network",
          "category": "Networking"
        }
      },
      {
        "search": {
          "query": "Type=Event EventID=4198 OR EventID=4199 Source=\"TCPIP\" EventLog=\"System\" TimeGenerated>NOW-24HOURS",
          "name": "Duplicate IP address has been detected",
          "category": "Networking"
        }
      },
      {
        "search": {
          "query": "Type=Event EventID=98 Source=\"Microsoft-Windows-Ntfs\" EventLog=\"System\" TimeGenerated>NOW-24HOURS | Measure Count() By Computer",
          "name": "NTFS File System Corruption",
          "category": "NTFS"
        }
      },
      {
        "search": {
          "query": "Type=Event EventID=40 OR EventID=36 Source=\"DISK\" EventLog=\"System\" TimeGenerated>NOW-24HOURS | Measure Count() By Compute",
          "name": "NTFS Quouta treshold limit reached",
          "category": "NTFS"
        }
      }
    ]
  },
  "resources": [
    {
      "name": "[variables('AAName')]",
      "type": "Microsoft.Automation/automationAccounts",
      "apiVersion": "2020-01-13-preview",
      "location": "[If(contains(parameters('Global'),'AALocation'),parameters('Global').AALocation,resourceGroup().location)]",
      "dependsOn": [],
      "properties": {
        "sku": {
          "name": "[variables('AAserviceTier')]"
        }
      },
      "resources": [
        {
          "type": "providers/diagnosticSettings",
          "name": "Microsoft.Insights/service",
          "dependsOn": [
            "[concat('Microsoft.Automation/automationAccounts/', variables('AAName'))]",
            "[concat('Microsoft.OperationalInsights/workspaces/', variables('OMSworkspaceName'))]"
          ],
          "apiVersion": "2017-05-01-preview",
          "properties": {
            "workspaceId": "[variables('OMSworkspaceID')]",
            "logs": [
              {
                "category": "JobLogs",
                "enabled": true,
                "retentionPolicy": {
                  "days": 0,
                  "enabled": false
                }
              },
              {
                "category": "JobStreams",
                "enabled": true,
                "retentionPolicy": {
                  "days": 0,
                  "enabled": false
                }
              },
              {
                "category": "DscNodeStatus",
                "enabled": true,
                "retentionPolicy": {
                  "days": 0,
                  "enabled": false
                }
              }
            ],
            "metrics": [
              {
                "timeGrain": "PT5M",
                "enabled": true,
                "retentionPolicy": {
                  "enabled": false,
                  "days": 0
                }
              }
            ]
          }
        }
      ]
    },
    //{
    //  "apiVersion": "2015-10-31",
    //  "type": "Microsoft.Automation/automationAccounts/modules",
    //  "name": "[concat(variables('AAName'), '/', variables('aaAssets').modules[copyIndex()].Name)]",
    // "location": "[resourceGroup().location]",
    //  "dependsOn": [
    //    "[resourceId('Microsoft.Automation/automationAccounts/', variables('AAName'))]"
    //  ],
    //  "copy": {
    //    "name": "modulesLoop",
    //    "count": "[length(variables('aaAssets').modules)]"
    //  },
    //  "properties": {
    //    "contentLink": {
    //      "uri": "[variables('aaAssets').modules[copyIndex()].url]"
    //    }
    //  }
    //},
    {
      "apiVersion": "2020-10-01",
      "type": "Microsoft.OperationalInsights/workspaces",
      "name": "[variables('OMSworkspaceName')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Automation/automationAccounts/', variables('AAName'))]"
      ],
      "properties": {
        "sku": {
          "Name": "[variables('serviceTier')]"
        },
        "retention": "[variables('dataRetention')]",
        "features": {
          "legacy": 0,
          "searchVersion": 1,
          "enableLogAccessUsingOnlyResourcePermissions": false
        }
      },
      "resources": [
        {
          "type": "providers/diagnosticSettings",
          "name": "Microsoft.Insights/service",
          "dependsOn": [
            "[variables('OMSworkspaceName')]"
          ],
          "apiVersion": "2017-05-01-preview",
          "properties": {
            "workspaceId": "[variables('OMSworkspaceID')]",
            "logs": [
              {
                "category": "Audit",
                "enabled": true
              }
            ],
            "metrics": [
              {
                "timeGrain": "PT5M",
                "enabled": true,
                "retentionPolicy": {
                  "enabled": false,
                  "days": 0
                }
              }
            ]
          }
        },
        {
          "apiVersion": "2015-11-01-preview",
          "type": "linkedServices",
          "name": "Automation",
          "location": "[resourceGroup().location]",
          "dependsOn": [
            "[concat('Microsoft.OperationalInsights/workspaces/', variables('OMSworkspaceName'))]",
            "[concat('Microsoft.Automation/automationAccounts/', variables('AAName'))]"
          ],
          "properties": {
            "resourceId": "[resourceId('Microsoft.Automation/automationAccounts',variables('AAName'))]"
          }
        }
      ]
    },
    {
      // https://docs.microsoft.com/en-us/azure/azure-monitor/insights/vminsights-health-configure-dcr
      "condition": "[equals(parameters('Extensions').VMInsights,1)]",
      "type": "Microsoft.Insights/dataCollectionRules",
      "apiVersion": "2019-11-01-preview",
      "name": "[replace(concat(variables('DeploymentURI'),'VMInsights'),'-','')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.OperationalInsights/workspaces/', variables('OMSworkspaceName'))]"
      ],
      "properties": {
        "description": "Data collection rule for VM Insights health.",
        "dataSources": {
          "windowsEventLogs": [
            {
              "name": "cloudSecurityTeamEvents",
              "streams": [
                "Microsoft-WindowsEvent"
              ],
              "scheduledTransferPeriod": "PT1M",
              "xPathQueries": [
                "Security!"
              ]
            },
            {
              "name": "appTeam1AppEvents",
              "streams": [
                "Microsoft-WindowsEvent"
              ],
              "scheduledTransferPeriod": "PT5M",
              "xPathQueries": [
                "System![System[(Level = 1 or Level = 2 or Level = 3)]]",
                "Application!*[System[(Level = 1 or Level = 2 or Level = 3)]]"
              ]
            }
          ],
          "syslog": [
            {
              "name": "cronSyslog",
              "streams": [
                "Microsoft-Syslog"
              ],
              "facilityNames": [
                "cron"
              ],
              "logLevels": [
                "Debug",
                "Critical",
                "Emergency"
              ]
            },
            {
              "name": "syslogBase",
              "streams": [
                "Microsoft-Syslog"
              ],
              "facilityNames": [
                "syslog"
              ],
              "logLevels": [
                "Alert",
                "Critical",
                "Emergency"
              ]
            }
          ],
          "performanceCounters": [
            {
              "name": "VMHealthPerfCounters",
              "scheduledTransferPeriod": "PT1M",
              "samplingFrequencyInSeconds": 30,
              "counterSpecifiers": [
                "\\Memory\\Available Bytes",
                "\\Memory\\Committed Bytes",
                "\\Processor(_Total)\\% Processor Time",
                "\\LogicalDisk(*)\\% Free Space",
                "\\LogicalDisk(_Total)\\Free Megabytes",
                "\\PhysicalDisk(_Total)\\Avg. Disk Queue Length"
              ],
              "streams": [
                "Microsoft-Perf"
              ]
            },
            {
              "name": "appTeamExtraCounters",
              "streams": [
                "Microsoft-Perf"
              ],
              "scheduledTransferPeriod": "PT5M",
              "samplingFrequencyInSeconds": 30,
              "counterSpecifiers": [
                "\\Process(_Total)\\Thread Count"
              ]
            }
          ],
          "extensions": [
            {
              "name": "Microsoft-VMInsights-Health",
              "streams": [
                "Microsoft-HealthStateChange"
              ],
              "extensionName": "HealthExtension",
              "extensionSettings": {
                "schemaVersion": "1.0",
                "contentVersion": "",
                "healthRuleOverrides": [
                  {
                    "scopes": [ "*" ],
                    "monitors": [ "root" ],
                    "monitorConfiguration": {},
                    "alertConfiguration": {
                      "isEnabled": true
                    }
                  }
                ]
              },
              "inputDataSources": [
                "VMHealthPerfCounters"
              ]
            }
          ]
        },
        "destinations": {
          "logAnalytics": [
            {
              "workspaceResourceId": "[variables('OMSworkspaceID')]",
              "name": "LogAnalyticsWorkspace"
            }
          ]
        },
        "dataFlows": [
          {
            "streams": [
              "Microsoft-HealthStateChange",
              "Microsoft-Perf",
              "Microsoft-Syslog",
              "Microsoft-WindowsEvent"
            ],
            "destinations": [
              "LogAnalyticsWorkspace"
            ]
          }
        ]
      }
    },
    {
      "name": "[variables('AppInsightsName')]",
      "type": "microsoft.insights/components",
      "apiVersion": "2015-05-01",
      "location": "[resourceGroup().location]",
      "kind": "other",
      "dependsOn": [
        "[concat('Microsoft.OperationalInsights/workspaces/', variables('OMSworkspaceName'))]"
      ],
      "properties": {
        "Application_Type": "web",
        "Flow_Type": null,
        "Request_Source": "AzureTfsExtensionAzureProject",
        "HockeyAppId": "",
        "SamplingPercentage": null
      },
      "resources": [
        {
          "type": "providers/diagnosticSettings",
          "name": "Microsoft.Insights/service",
          "apiVersion": "2015-07-01",
          "dependsOn": [
            "[variables('AppInsightsName')]"
          ],
          "properties": {
            "workspaceId": "[variables('OMSworkspaceID')]",
            "logs": [
              {
                "enabled": true,
                "Category": "AppAvailabilityResults"
              },
              {
                "enabled": true,
                "Category": "AppBrowserTimings"
              },
              {
                "enabled": true,
                "Category": "AppEvents"
              },
              {
                "enabled": true,
                "Category": "AppMetrics"
              },
              {
                "enabled": true,
                "Category": "AppDependencies"
              },
              {
                "enabled": true,
                "Category": "AppExceptions"
              },
              {
                "enabled": true,
                "Category": "AppPageViews"
              },
              {
                "enabled": true,
                "Category": "AppPerformanceCounters"
              },
              {
                "enabled": true,
                "Category": "AppRequests"
              },
              {
                "enabled": true,
                "Category": "AppSystemEvents"
              },
              {
                "enabled": true,
                "Category": "AppTraces"
              }
            ],
            "metrics": [
              {
                "timeGrain": "PT5M",
                "enabled": true,
                "retentionPolicy": {
                  "enabled": false,
                  "days": 0
                }
              }
            ]
          }
        }
      ]
    },
    // {
    //   "condition": "[equals(length(variables('appConfigurationInfo')),1)]",
    //   "type": "Microsoft.AppConfiguration/configurationStores/keyValues",
    //   "apiVersion": "2020-07-01-preview",
    //   "name": "[concat(variables('Deployment'),'-ac',if(contains(variables('appConfigurationInfo'),'Name'),variables('appConfigurationInfo').Name,''),'/InstrumentationKey')]",
    //   "dependsOn": [
    //     "[variables('AppInsightsName')]"
    //   ],
    //   "properties": {
    //     "value": "[reference(resourceId('Microsoft.Insights/components', variables('AppInsightsName')), '2015-05-01').InstrumentationKey]",
    //     "contentType": "richtext"
    //     // "tags": "[variables('Deployment')]"
    //   }
    // },
    {
      "condition": "[equals(parameters('Stage').OMSDataSources,1)]",
      "apiVersion": "2015-11-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/dataSources",
      "name": "[concat(variables('OMSworkspaceName'), '/', variables('dataSources')[copyIndex()].name)]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.OperationalInsights/workspaces/', variables('OMSworkspaceName'))]"
      ],
      "copy": {
        "name": "dataSourcesCopy",
        "count": "[length(variables('dataSources'))]"
      },
      "kind": "[variables('dataSources')[copyIndex()].kind]",
      "properties": "[variables('dataSources')[copyIndex()].properties]"
    },
    {
      "condition": "[equals(parameters('Stage').OMSSolutions,1)]",
      "apiVersion": "2015-11-01-preview",
      "type": "Microsoft.OperationsManagement/solutions",
      "name": "[concat( variables('solutions')[copyIndex()],'(', variables('omsWorkspaceName'),')')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName'))]"
      ],
      "copy": {
        "name": "solutionCopy",
        "count": "[length(variables('solutions'))]"
      },
      "properties": {
        "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('omsWorkspaceName'))]"
      },
      "plan": {
        "name": "[concat( variables('solutions')[copyIndex()],'(', variables('omsWorkspaceName'),')')]",
        "product": "[concat('OMSGallery/', variables('solutions')[copyIndex()])]",
        "promotionCode": "",
        "publisher": "Microsoft"
      }
    },
    {
      "name": "[concat(variables('omsWorkspaceName'), '/', toLower(variables('alertInfo')[copyIndex()].search.category), '|', toLower(variables('alertInfo')[copyIndex()].search.name))]",
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "2017-03-15-preview",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName'))]"
      ],
      "copy": {
        "name": "cf.alert.searches",
        "mode": "Parallel",
        "count": "[length(variables('alertInfo'))]"
      },
      "properties": {
        "etag": "*",
        "query": "[variables('alertInfo')[copyIndex()].search.query]",
        "displayName": "[concat(variables('alertInfo')[copyIndex()].search.name)]",
        "category": "[variables('alertInfo')[copyIndex()].search.category]"
      }
    }
    //{
    //  "condition": "[contains(variables('alertInfo')[copyIndex(0)],'alert')]",
    //  "name": "[concat(variables('omsWorkspaceName'), '/', toLower(variables('alertInfo')[copyIndex()].search.category), '|', toLower(variables('alertInfo')[copyIndex()].search.name), '/', 'schedule-', uniqueString(resourceGroup().id, deployment().name, variables('omsWorkspaceName'), '/', variables('alertInfo')[copyIndex()].search.category, '|', variables('alertInfo')[copyIndex()].search.name))]",
    //  "type": "Microsoft.OperationalInsights/workspaces/savedSearches/schedules",
    //  "apiVersion": "2017-03-15-preview",
    //  "dependsOn": [
    //    "[concat('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName'))]"
    //  ],
    //  "copy": {
    //    "name": "cf.alert.schedules",
    //    "mode": "Parallel",
    //    "count": "[length(variables('alertInfo'))]"
    //  },
    //  "dependsOn": [
    //    "[concat('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName'), '/savedSearches/', toLower(variables('alertInfo')[copyIndex()].search.category), '|', toLower(variables('alertInfo')[copyIndex()].search.name))]"
    //  ],
    //  "properties": {
    //    "etag": "*",
    //    "interval": "[variables('alertInfo')[copyIndex()].alert.schedule.interval]",
    //    "queryTimeSpan": "[variables('alertInfo')[copyIndex()].alert.schedule.timeSpan]",
    //    "enabled": "[variables('alertInfo')[copyIndex()].alert.enabled]"
    //  }
    //},
    //{
    //  "condition": "[contains(variables('alertInfo')[copyIndex(0)],'alert')]",
    //  "name": "[concat(variables('omsWorkspaceName'), '/', toLower(variables('alertInfo')[copyIndex()].search.category), '|', toLower(variables('alertInfo')[copyIndex()].search.name), '/', 'schedule-', uniqueString(resourceGroup().id, deployment().name, variables('omsWorkspaceName'), '/', variables('alertInfo')[copyIndex()].search.category, '|', variables('alertInfo')[copyIndex()].search.name), '/', 'alert-', uniqueString(resourceGroup().id, deployment().name, variables('omsWorkspaceName'), '/', variables('alertInfo')[copyIndex()].search.category, '|', variables('alertInfo')[copyIndex()].search.name))]",
    //  "type": "Microsoft.OperationalInsights/workspaces/savedSearches/schedules/actions",
    //  "apiVersion": "2017-03-15-preview",
    //  "dependsOn": [
    //    "[concat('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName'))]"
    //  ],
    //  "copy": {
    //    "name": "cf.alert.alerts",
    //    "mode": "Parallel",
    //    "count": "[length(variables('alertInfo'))]"
    //  },
    //  "dependsOn": [
    //    "[concat('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName'), '/savedSearches/', toLower(variables('alertInfo')[copyIndex()].search.category), '|', toLower(variables('alertInfo')[copyIndex()].search.name))]",
    //    "[concat('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName'), '/savedSearches/', toLower(variables('alertInfo')[copyIndex()].search.category), '|', toLower(variables('alertInfo')[copyIndex()].search.name), '/schedules/','schedule-',uniqueString(resourceGroup().id, deployment().name,variables('omsWorkspaceName'), '/', variables('alertInfo')[copyIndex()].search.category, '|', variables('alertInfo')[copyIndex()].search.name))]"
    //  ],
    //  "properties": {
    //    "etag": "*",
    //    "Type": "Alert",
    //    "name": "[variables('alertInfo')[copyIndex()].alert.displayName]",
    //    "Description": "[variables('alertInfo')[copyIndex()].alert.description]",
    //    "Severity": "[variables('alertInfo')[copyIndex()].alert.severity]",
    //    "Threshold": {
    //      "Operator": "[variables('alertInfo')[copyIndex()].alert.thresholdOperator]",
    //      "Value": "[variables('alertInfo')[copyIndex()].alert.thresholdValue]"
    //    },
    //    "Throttling": {
    //      "DurationInMinutes": "[variables('alertInfo')[copyIndex()].alert.throttleMinutes]"
    //    },
    //    "emailNotification": "[if(contains(variables('alertInfo')[copyIndex()].alert, 'emailNotification'), variables('alertInfo')[copyIndex()].alert.emailNotification, json('null'))]"
    //  }
    //}
  ]
}